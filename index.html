<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>הלאה בקיצר – מוזיקה </title>
    <style>
      :root {
        --bg: #121217;
        --card: #1f1f27;
        --txt: #eaeaea;
        --acc: #ffcc00; /* נקודת דגש לכדורים • וכד' */
        --muted: #2a2a35;
        --btn: #d7263d;
        --btnh: #f44336;
        /* צבעי קישורים – קריאים מאוד על רקע כהה */
        --link: #8be9fd; /* תכלת-ציאן בהיר (קריא על שחור) */
        --link-hover: #ffffff;
        --link-visited: #b6a1ff; /* אופציונלי – סגול בהיר לביקור */
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--txt);
        font-family: "Segoe UI", system-ui, Arial, sans-serif;
        direction: rtl;
      }
      .wrap {
        max-width: 1100px;
        margin: auto;
        padding: 18px;
      }
      h1 {
        margin: 6px 0 14px;
        text-align: center;
      }
      /* קישורים – קריאות גבוהה על כהה */
      a {
        color: var(--link);
        text-decoration: none;
        font-weight: 600;
      }
      a:hover,
      a:focus-visible {
        color: var(--link-hover);
        text-decoration: underline;
        outline: none;
      }
      a:visited {
        color: var(--link-visited);
      }

      .toolbar {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 14px;
      }
      .btn,
      select {
        background: var(--btn);
        color: #fff;
        border: 0;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn:hover {
        background: var(--btnh);
      }
      .secondary {
        background: transparent;
        color: var(--txt);
        border: 1px solid #ffffff26;
      }
      select {
        appearance: none;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 14px;
      }
      .card {
        background: var(--card);
        border: 1px solid #ffffff14;
        border-radius: 14px;
        padding: 14px;
      }
      .card h2 {
        margin: 0 0 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--muted);
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 1rem;
      }
      .card h2 img {
        width: 20px;
        height: 20px;
        border-radius: 4px;
      }
      ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      li {
        padding-right: 14px;
        position: relative;
        margin: 0 0 10px;
      }
      li::before {
        content: "•";
        position: absolute;
        right: 0;
        color: var(--acc);
      }
      .src {
        font-size: 0.72rem;
        background: #ffffff14;
        padding: 2px 8px;
        border-radius: 999px;
        margin-left: 6px;
      }
      .time {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 4px;
      }
      .snip {
        display: none;
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 4px;
      }
      body.show-snips .snip {
        display: block;
      }
      .ltr {
        direction: ltr;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>הלאה בקיצר</h1>

      <div class="toolbar">
        <button class="btn" id="refresh">רענן</button>
        <button class="btn" id="toggleSnips">הצג תקצירים</button>
        <button class="btn secondary" id="toggleView" data-mode="source">
          תצוגה: לפי מקור
        </button>
        <select class="secondary" id="perSource">
          <option value="3">3 לפר מקור</option>
          <option value="5" selected>5 לפר מקור</option>
          <option value="10">10 לפר מקור</option>
        </select>
        <select class="secondary" id="combinedCap">
          <option value="20">20 במשולב</option>
          <option value="40" selected>40 במשולב</option>
          <option value="60">60 במשולב</option>
        </select>
      </div>

      <div id="status"></div>
      <div class="grid" id="grid"></div>

      <template id="cardTmpl">
        <div class="card">
          <h2><img alt="" /><span class="title"></span></h2>
          <ul class="list"></ul>
        </div>
      </template>

      <template id="combinedTmpl">
        <div class="card">
          <h2>כותרות אחרונות (משולב)</h2>
          <ul class="list"></ul>
          <div class="time">ממויין לפי זמן הפרסום (חדש לישן)</div>
        </div>
      </template>
    </div>

    <script>
      const feeds = [
        {
          name: "Mako-Music",
          url: "https://rcs.mako.co.il/rss/f6750a2610f26110VgnVCM1000005201000aRCRD.xml",
          lang: "rtl",
        },
        {
          name: "Ynet – תרבות",
          url: "https://www.ynet.co.il/Integration/StoryRss1854.xml",
          lang: "rtl",
        },
        {
          name: "XXL (Hip-Hop)",
          url: "https://www.xxlmag.com/feed/",
          lang: "ltr",
        },
        {
          name: "Walla תרבות",
          url: "https://rss.walla.co.il/feed/272",
          lang: "rtl",
        },
        {
          name: "Pitchfork News",
          url: "https://pitchfork.com/rss/news/",
          lang: "ltr",
        },
      ];

      // ---- עזר קצר ----
      const $ = (s, r = document) => r.querySelector(s);
      const grid = $("#grid"),
        status = $("#status");

      // מצב + טעינת העדפות לפני סנכרון ה־UI (כדי למנוע פליקר)
      const state = {
        view: "source", // 'source' | 'combined'
        perSource: Number(localStorage.getItem("perSource") || 5),
        combinedCap: Number(localStorage.getItem("combinedCap") || 40),
        data: null,
      };
      const savedView = localStorage.getItem("viewMode");
      if (savedView === "source" || savedView === "combined") {
        state.view = savedView;
      }

      // סנכרון ה־UI לפי מצב קיים
      $("#perSource").value = String(state.perSource);
      $("#combinedCap").value = String(state.combinedCap);
      $("#toggleView").dataset.mode = state.view;
      $("#toggleView").textContent =
        "תצוגה: " + (state.view === "combined" ? "משולב" : "לפי מקור");

      function txt(s) {
        const d = document.createElement("div");
        d.innerHTML = s || "";
        return d.textContent || "";
      }
      function getDate(n) {
        return (
          n.querySelector("pubDate,updated,published,dc\\:date")?.textContent ||
          ""
        );
      }
      function rel(date) {
        const d = new Date(date);
        if (isNaN(d)) return "";
        const diff = (d - new Date()) / 1000;
        const abs = Math.abs(diff);
        const steps = [
          [60, "seconds"],
          [60, "minutes"],
          [24, "hours"],
          [7, "days"],
          [4.345, "weeks"],
          [12, "months"],
          [1 / 0, "years"],
        ];
        let acc = 1,
          unit = "seconds",
          val = diff;
        for (const [s, u] of steps) {
          if (abs < acc * s) {
            unit = u;
            val = diff / acc;
            break;
          }
          acc *= s;
        }
        try {
          return new Intl.RelativeTimeFormat("he-IL", {
            numeric: "auto",
          }).format(Math.round(val), unit);
        } catch {
          return "";
        }
      }
      function icon(u) {
        try {
          return (
            "https://www.google.com/s2/favicons?sz=64&domain_url=" +
            new URL(u).origin
          );
        } catch {
          return "";
        }
      }

      async function fetchFeed(feed, limit) {
        const url = `https://api.allorigins.win/get?url=${encodeURIComponent(
          feed.url
        )}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const contents = json?.contents || "";
        if (!contents) return { feed, items: [] }; // הגנה: אין תוכן

        const xml = new DOMParser().parseFromString(contents, "text/xml");
        if (xml.querySelector("parsererror")) return { feed, items: [] }; // שגיאת פרסר? נחזיר ריק

        const nodes = [...xml.querySelectorAll("item,entry")];
        const items = nodes
          .map((n) => {
            const l =
              n.querySelector("link")?.getAttribute?.("href") ||
              n.querySelector("link")?.textContent ||
              "#";
            return {
              title: txt(
                n.querySelector("title")?.textContent || "(ללא כותרת)"
              ),
              link: l,
              desc: txt(
                n.querySelector("description,summary,content")?.textContent ||
                  ""
              ),
              date: txt(getDate(n)),
            };
          })
          .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
          .slice(0, limit);
        return { feed, items };
      }

      function renderSource(data) {
        grid.innerHTML = "";
        data.forEach(({ feed, items }) => {
          const card = document.importNode($("#cardTmpl").content, true);
          const root = card.querySelector(".card");
          if (feed.lang === "ltr") root.classList.add("ltr");
          card.querySelector("img").src = icon(feed.url);
          card.querySelector(".title").textContent = feed.name;
          const ul = card.querySelector(".list");

          const limited = items.slice(0, state.perSource);
          if (!limited.length) {
            const li = document.createElement("li");
            li.innerHTML = `<div class="time">אין פריטים להצגה כרגע.</div>`;
            ul.appendChild(li);
          } else {
            limited.forEach((it) => {
              const li = document.createElement("li");
              li.innerHTML = `<div><a href="${
                it.link
              }" target="_blank" rel="noopener">${it.title}</a></div>
                              <div class="snip">${it.desc}</div>
                              <div class="time">${txt(it.date)} · ${rel(
                it.date
              )}</div>`;
              ul.appendChild(li);
            });
          }

          grid.appendChild(card);
        });
      }

      function renderCombined(data) {
        grid.innerHTML = "";
        const card = document.importNode($("#combinedTmpl").content, true);
        const ul = card.querySelector(".list");
        const seen = new Set(),
          out = [];
        const host = (u) => {
          try {
            return new URL(u).host.replace(/^www\./, "");
          } catch {
            return "";
          }
        };
        const perSrc = {};

        data.forEach(({ feed, items }) => {
          items.forEach((it) => {
            perSrc[feed.name] = perSrc[feed.name] || 0;
            if (perSrc[feed.name] >= state.perSource) return;
            const key = `${host(it.link)}|${(it.title || "").trim()}`;
            if (seen.has(key)) return;
            seen.add(key);
            out.push({ ...it, source: feed.name, lang: feed.lang });
            perSrc[feed.name]++;
          });
        });

        out.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
        out.slice(0, state.combinedCap).forEach((it) => {
          const li = document.createElement("li");
          if (it.lang === "ltr") li.classList.add("ltr");
          li.innerHTML = `<div><span class="src">${it.source}</span><a href="${
            it.link
          }" target="_blank" rel="noopener">${it.title}</a></div>
                          <div class="snip">${it.desc}</div>
                          <div class="time">${txt(it.date)} · ${rel(
            it.date
          )}</div>`;
          ul.appendChild(li);
        });
        grid.appendChild(card);
      }

      async function load() {
        status.textContent = "";
        try {
          const jobs = feeds.map((f) => fetchFeed(f, state.perSource));
          const results = await Promise.allSettled(jobs);
          const ok = results
            .filter((r) => r.status === "fulfilled")
            .map((r) => r.value);
          state.data = ok;
          (state.view === "combined" ? renderCombined : renderSource)(ok);
          status.textContent = `${ok.length}/${feeds.length} נטענו`;
        } catch (e) {
          status.textContent = "שגיאה בטעינת פידים";
          console.error(e);
        }
      }

      // ---- אינטראקציה ----
      $("#refresh").addEventListener("click", load);
      $("#toggleSnips").addEventListener("click", (e) => {
        document.body.classList.toggle("show-snips");
        e.currentTarget.textContent = document.body.classList.contains(
          "show-snips"
        )
          ? "הסתר תקצירים"
          : "הצג תקצירים";
      });
      $("#toggleView").addEventListener("click", (e) => {
        state.view =
          e.currentTarget.dataset.mode === "combined" ? "source" : "combined";
        e.currentTarget.dataset.mode = state.view;
        e.currentTarget.textContent =
          "תצוגה: " + (state.view === "combined" ? "משולב" : "לפי מקור");
        (state.view === "combined" ? renderCombined : renderSource)(
          state.data || []
        );
        localStorage.setItem("viewMode", state.view);
      });
      $("#perSource").addEventListener("change", async () => {
        state.perSource = Number($("#perSource").value);
        localStorage.setItem("perSource", String(state.perSource));
        await load(); // צריך למשוך מחדש כדי להגדיל/להקטין פר מקור
      });
      $("#combinedCap").addEventListener("change", () => {
        state.combinedCap = Number($("#combinedCap").value);
        localStorage.setItem("combinedCap", String(state.combinedCap));
        if (state.view === "combined" && state.data) renderCombined(state.data);
      });

      // אם הגיעת כבר עם תקצירים מוצגים, עדכן טקסט כפתור
      if (document.body.classList.contains("show-snips")) {
        $("#toggleSnips").textContent = "הסתר תקצירים";
      }

      load();
    </script>
  </body>
</html>
